name: Deploy to cPanel Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  PHP_VERSION: "8.3"

jobs:
  # Job 1: Run tests before deployment
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, curl
          coverage: none

      - name: ğŸ“¦ Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: ğŸ”„ Cache Composer Dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: ğŸ”§ Install Dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: ğŸ§ª Run Test Suite
        run: |
          echo "âœ… Running test suite..."
          composer test
          echo "ğŸ‰ All tests passed!"

  # Job 2: Build and deploy (only after tests pass)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, curl, zip
          ini-values: post_max_size=256M, upload_max_filesize=256M, memory_limit=512M
          coverage: none

      - name: âœ… Validate Composer
        run: |
          composer validate --strict --no-check-publish
          echo "âœ… Composer validation passed"

      - name: ğŸ“¦ Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: ğŸ”„ Cache Composer Dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-prod-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-prod-

      - name: ğŸš€ Install Production Dependencies
        run: |
          composer install \
            --no-dev \
            --no-interaction \
            --no-progress \
            --optimize-autoloader \
            --classmap-authoritative \
            --prefer-dist
          echo "âœ… Production dependencies installed"

      - name: ğŸ”§ Create Production Environment
        run: |
          echo "Creating production environment file..."
          cat > .env << EOF
          # Database Configuration
          DB_HOST=${{ secrets.DB_HOST }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=${{ secrets.DB_PORT || '3306' }}

          # Application Configuration
          APP_ENV=production
          APP_DEBUG=false
          APP_URL=${{ secrets.APP_URL || 'https://mockerjson.xyz' }}

          # Security
          APP_KEY=${{ secrets.APP_KEY }}
          SECURE_SSL=true
          EOF

          # Validate .env file
          if [ -f .env ]; then
            echo "âœ… Production .env file created successfully"
            echo "ğŸ“„ Environment variables configured: $(grep -c "=" .env) variables"
          else
            echo "âŒ Failed to create .env file"
            exit 1
          fi

      - name: ğŸ—‚ï¸ Prepare Deployment Files
        run: |
          echo "Preparing files for deployment..."

          # Create deployment directory
          mkdir -p deploy

          # Copy application files
          cp -r app/ deploy/
          cp -r bootstrap/ deploy/
          cp -r config/ deploy/
          cp -r public/ deploy/
          cp -r routes/ deploy/
          cp -r storage/ deploy/
          cp -r vendor/ deploy/

          # Copy configuration files
          cp .env deploy/
          cp composer.json deploy/

          # Create necessary directories with proper permissions
          mkdir -p deploy/storage/logs
          chmod -R 755 deploy/storage/

          # Set proper file permissions
          find deploy/ -type f -exec chmod 644 {} \;
          find deploy/ -type d -exec chmod 755 {} \;

          # Make sure .env is readable
          chmod 644 deploy/.env

          echo "âœ… Deployment files prepared"
          echo "ğŸ“¦ Total files: $(find deploy/ -type f | wc -l)"
          echo "ğŸ“ Total directories: $(find deploy/ -type d | wc -l)"

      - name: ğŸ§¹ Production Cleanup
        run: |
          echo "Cleaning up development files..."

          # Remove development and testing files
          rm -rf deploy/tests/ 2>/dev/null || true
          rm -f deploy/.git* 2>/dev/null || true
          rm -f deploy/phpunit.xml* 2>/dev/null || true
          rm -f deploy/Pest.php 2>/dev/null || true
          rm -f deploy/README.md 2>/dev/null || true
          rm -f deploy/composer.lock 2>/dev/null || true

          # Remove any hidden development files
          find deploy/ -name ".*" -type f ! -name ".env" -delete 2>/dev/null || true
          find deploy/ -name "*.md" -type f -delete 2>/dev/null || true
          find deploy/ -name ".DS_Store" -type f -delete 2>/dev/null || true

          echo "âœ… Development files cleaned up"

      - name: ğŸ” Security Hardening
        run: |
          echo "Applying security hardening..."

          # Create .htaccess for public directory if it doesn't exist
          if [ ! -f deploy/public/.htaccess ]; then
            cat > deploy/public/.htaccess << 'EOF'
          RewriteEngine On

          # Handle Angular and Vue.js routes
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^(.*)$ index.php [QSA,L]

          # Security headers
          Header always set X-Content-Type-Options nosniff
          Header always set X-Frame-Options DENY
          Header always set X-XSS-Protection "1; mode=block"
          Header always set Referrer-Policy "strict-origin-when-cross-origin"

          # Hide server signature
          ServerTokens Prod
          EOF
          fi

          # Secure sensitive directories
          echo "Deny from all" > deploy/storage/.htaccess
          echo "Deny from all" > deploy/app/.htaccess
          echo "Deny from all" > deploy/bootstrap/.htaccess
          echo "Deny from all" > deploy/config/.htaccess

          echo "âœ… Security hardening applied"

      - name: ğŸš€ Deploy to cPanel via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.FTP_HOST }}
          port: ${{ secrets.FTP_PORT || '21' }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local_path: "./deploy/"
          remote_path: ${{ secrets.REMOTE_PATH || '/public_html/' }}
          sftp_only: false
          delete_remote_files: false
        env:
          DEPLOY_TIMEOUT: 60000

      - name: ğŸ¥ Post-Deployment Health Check
        run: |
          echo "Waiting for deployment to settle..."
          sleep 45

          API_URL="${{ secrets.APP_URL || 'https://mockerjson.xyz' }}"

          echo "ğŸ” Testing API endpoints..."

          # Test main endpoint
          echo "Testing main endpoint: $API_URL"
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL" || echo "000")

          # Test API endpoint
          echo "Testing API endpoint: $API_URL/api/v1/products"
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/v1/products" || echo "000")

          # Check results
          if [ "$MAIN_STATUS" = "200" ] && [ "$API_STATUS" = "200" ]; then
            echo "âœ… Health check PASSED"
            echo "ğŸŒ Main site: HTTP $MAIN_STATUS"
            echo "ğŸ”— API endpoint: HTTP $API_STATUS"
            echo "ğŸ‰ Deployment successful!"
          else
            echo "âŒ Health check FAILED"
            echo "ğŸŒ Main site: HTTP $MAIN_STATUS"
            echo "ğŸ”— API endpoint: HTTP $API_STATUS"
            echo "::warning::Some endpoints may not be responding correctly"
          fi

          # Test a sample API response
          echo "ğŸ§ª Testing API response..."
          SAMPLE_RESPONSE=$(curl -s "$API_URL/api/v1/products?limit=1" | head -c 100)
          if [[ $SAMPLE_RESPONSE == *"success"* ]]; then
            echo "âœ… API is returning expected JSON responses"
          else
            echo "âš ï¸ API response format may have issues"
          fi

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "
          ## ğŸ“‹ Deployment Summary

          **ğŸ¯ Target:** ${{ secrets.APP_URL || 'https://mockerjson.xyz' }}
          **ğŸ“… Time:** $(date)
          **ğŸ”§ PHP Version:** ${{ env.PHP_VERSION }}
          **ğŸ“¦ Commit:** ${{ github.sha }}
          **ğŸ‘¤ Triggered by:** ${{ github.actor }}
          **ğŸŒ¿ Branch:** ${{ github.ref_name }}
          **ğŸ’¼ Status:** ${{ job.status }}

          **ğŸ”— Quick Links:**
          - ğŸ  Homepage: ${{ secrets.APP_URL || 'https://mockerjson.xyz' }}
          - ğŸ“± Products API: ${{ secrets.APP_URL || 'https://mockerjson.xyz' }}/api/v1/products
          - ğŸ“ Posts API: ${{ secrets.APP_URL || 'https://mockerjson.xyz' }}/api/v1/posts

          " >> $GITHUB_STEP_SUMMARY

      - name: ğŸ§¹ Cleanup Deployment Files
        if: always()
        run: |
          rm -rf deploy/
          rm -f .env
          echo "âœ… Cleanup completed"

  # Job 3: Notify deployment result
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
      - name: ğŸ“§ Deployment Notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
            echo "âœ… Tests passed"
            echo "âœ… Deployment completed"
            echo "ğŸŒ Live at: ${{ secrets.APP_URL || 'https://mockerjson.xyz' }}"
          else
            echo "ğŸ’¥ DEPLOYMENT FAILED!"
            echo "âŒ Check the logs above for details"
            if [ "${{ needs.test.result }}" != "success" ]; then
              echo "âŒ Tests failed"
            fi
            if [ "${{ needs.deploy.result }}" != "success" ]; then
              echo "âŒ Deployment failed"
            fi
          fi
